# Substrate：下一代区块链通用框架

## 区块链发展现状

为什么substrate会成为下一代通用框架？

以太坊在区块链发展过程中具有不可磨灭的贡献，但是由于历史包袱，更新迭代比较慢

EOS雷声大雨点小，舍弃了区块链去中心化，等特性，一味追求TPS，但也EOS的TPS仅有几千级别

市场比较浮躁，但技术需要迭代积累，区块链现阶段发展遇到瓶颈。区块链智能合约基本能用，但离大规模应用还差得远，目前区块链框架在扩展性/易用性/共识能源问题的局限性导致的。

区块链开发这如何保障自己的利益最大化，知识前沿化，把握发展的趋势。

代码不会说谎，登陆GitHub浏览各项目就知道了。

## 一、Substrate重塑区块链

现有区块链，只是验证了区块链Dapp能用，但没办法做到大规模应用，主要局限于三点，下面我们分三部分来分析Substrate如何解决这些问题。

Substrate之于区块链如同Linux之于操作系统。

### 扩展性：

1、现有区块链都是单链模式，一条链的最大的tps不能过万（单台计算机tps差不多10万tps,因为hash等加密算法的重复利用，链的tps<<1/10单台计算机计算）。Substrate可以灵活地拓展任意条parachain,好比现在的分布式计算，3台计算机算不过来，我们可以加机器；

2、各层结构的模块化：区块链大致由（p2p,rpc,consensus,storage,crypto）这几部分组成。但现有的链都是把这个几个模块糅合在一起；

parity团队因为在长期开发以太坊，积累了经验，把这几个模块往高层次抽象。如substrate会做到devp2p,libp2p网络一键切换。再如任意种hash算法替换；

3、任意代码的升级，比普通云服务器的升级更简便。因为每个substrate节点都含有两份可执行runtime内核代码。

一份是本地编译的二进制代码，另一份是在链上的wasm代码（跑在wasm虚拟机上的代码）。为什么两份代码就能解决了快速稳定升级？（无缝升级内核） 

因为Substrate两份代码同时执行，一份是wasm代码，一份是native代码，native代码是rust std版编译的二进制代码，wasm代码是跑在虚拟机上的代码，链执行过程会选择1、只执行wasm；2、只执行native，3、两者都执行。

substrate在执行时会做比较，先执行wasm再执行native，如果两者执行结果不一致，会以wasm为准。

为什么以wasm为准？

wasm是跟随区块一起成长的，初始化，set code是进行runtime升级，在第100个块升级了wasm,之后执行的按照快的顺序来执行，升级后的wasm覆盖了前一个wasm，跟着链跑，会一直正确执行；而native编译的二进制代码只是升级的最后一个版本。以太坊升级是一个大事件，每次升级都是native代码，都要重新下载最新的代码，才能保持版本同步。wasm代码一直在链上的，在链上所有版本都在链上，wasm执行的内核代码是不会有错的，执行wasm代码对硬分叉比较友好，跑在虚拟机上，性能有问题，native本地代码性能更好，所以在安全方面可以依靠wasm代码，在性能方面依靠native代码，在过渡阶段 两者都有，可以顺利过渡到下个版本。

Gavin wood在web3大会上掩饰了30分钟起一条链，30分钟升级一条链，郭时清比喻substrate可以"开着汽车换发动机”。可以把链的合成逻辑更新，完全变成另一条链，升级到下一个版本。

### 易用性：

rust有runtime，substrate也有runtime，runtime和操作系统中的kernel是一个意思

runtime合约——系统级别的合约，ChainX2018已经在写

contract合约——用户级别的合约，BBQ测试网

wasm合约，支持rust/c/c++ wasm的原生storage接口。

极高层次的抽象，可以使不同的开发人员做不同部分的开发，以下双层可扩展理解为多层，至少是双层。

- 双层执行code（native，wasm）
- 双层共识 aura+grandpa
- 双层合约 runtime + contract
- 双层p2p 以太坊的devp2p + IPFS的libp2p
- 多模版密码库 hash算法、椭圆曲线加密算法，可以自定义设置。

### 共识：

共识是命脉，但是和用户打交道较少，合约与用户打交道较多，安全在于共识。

1、多种共识并行交互执行，最早是algroud定义了快慢速通道共识并行，但那现在还是在白皮书里，现在的substrate就能做到aura+grandpa两种共识并行运行。aura是快共识，grandpa是慢共识，grandpa有确定性。aura牺牲确定性，产生的及时性。因为不可能三角对每一种共识是普遍存在的，但是可以把不可能三角里面，多种共识组合起来，然后可能达到最优化。不可能三角中第一个共识通过牺牲中心化，跑得快，如EOS；也可以牺牲性能，保证分散性确定性，如grandpa。

这种组合共识，既有pow的分散性，有没有他的能源浪费的问题，还有一个100%的确定性，而不是pow的概率确定性，尤其是性能方面，pow不可同日而语；

2、aura提供了快速并发出块性，像pow一样节点分散，可以支持100万节点同时在同一高度同时出块。

3、grandpa提供了确定性，只要用BFT确认最后一个大家公知的块即可。这对传统BFT的通信消息量减少99%以上。

***基于hash的共识，和基于签名的共识的优缺点对比：***

Pow是基于hash算法的共识，pos是基于签名的共识，pos都是确定性的；

hash摘要算法和椭圆曲线算法是区块链密码学两个核心，相辅相成，可以结合用也可以分散用，用到哪些层面，又有何优缺点，在各种层次应用中有何有缺点。

libp2p是IPFS团队定义的一个协议，是目前市面上支持各种协议最广，最稳定的p2p库，filecoin能筹集很多资金的一个重要原因是libp2p库做得好。

devp2p是以太坊的p2p层协议，比较单一简单

substrate将两者集成进来，都可以并行跑，也可以开发自己的p2p,可插拔式替换

***Rust***

- 社区特别open的语言，和区块链open的思想吻合
- 有c++的性能，没有c++运行时的不确定性
- 对wasm友善，从语言库级别支持std,no_std两套代码规范，no_std的代码兼容wasm这种确定性执行

二、创新方向

区块链技术现在都在努力往那些方面创新？

- 共识 （命脉）

  1、Cardano、Alground、difinity等等，这些项目都是以共识创新而闻名的项目，然而，这些项目的共识创新现在都只是停留在白皮书里。但Substrate已经实现了他们白皮书里所期望的共识效果；

  2、优秀共识所期望的点：像pow一样，大家都有同等的同时出块的公平权利，有没有他的能源浪费和性能问题。其实就是Substrate的aura+grandpa共识，也是VB所常说的casper

  3、casper和tendermint的比较，或者1年前的一些技术可以参考郭光华老婆翻译的一些文章：https://lilymoana.github.io/ConsensusCompare.html

- 隐私

  1、Bulletproof基于这协议的隐私币有许多https://www.jianshu.com/p/47c105f356f5

  2、零知识证明，parity团队也正在用substrate框架去实现zcash

  3、抗量子密码学，同态加密等理论加密算法的研究

- 合约VM （决定区块链命运）

  1、wasm阵营：基于wasm vm的链越来越多，根本原因是wasm生态特别丰富，wasm现在已经支持c/c++/rust等编译型语言，其他语言都是在支持的路途中

  2、非wasm阵营，如solidity等VM

三、Polkadot & ChainX

基于Substrate框架实现的Polkadot/ChainX简介

***Polkadot多链如何组织与管理***

1、共识的一致管理

共识由reley chain统一管理，各个parachain的验证人由relaychain随机随时分配。举个最简单的例子，比如polkadot网络由三条链组成（relay，para1, para2）,一共有7个验证人节点，那么relay chain管理共识的模块，可以采取2：2：3的个数随机分配给relay，para1,para2三条链随机出块，随机性/随时性，保证安全；

2、消息的统一路由

价值消息的共识，互换管理分配。IPC消息路由这是polkadot需要做的第二大部分，这部分在白皮书里有介绍，但是现正在展开中，大致的思路可以对比参看路由器的路由协议。只是这些不同链的路由，最后由relaychain统一管理。

***ChainX 多币如何组织与管理***

1、跨链方式的选择

这又回到之前提到的问题，hash和椭圆曲线谁更好的问题，两个例子：

- BTC：是用hash方式的共识，更优选择是链上轻节点；

- EOS：是椭圆曲线式的共识，更优选择分布式密钥多签。多签的方式，每换一次选举，21个出块节点也更新换代。

BTC没有用签名的方式，用的是难度叠加的pow共识方式，没有100%的确定性。6块，链上轻节点,确定性（多签）+不确定性（hash）=不确定性多签,分布式密钥+多签的方式不适用于BTC；轻节点和本链没有太多隔阂。

2、币在ChainX上价值的互换

ChainX会在Runtime合约层内嵌各种coin撮合的交易所，同时也会把这些API接口留给合约层，这样任何开发合约的用户，可以自如的选择任何比重作为价值驱动来开发自己的合约。比如，可以用BTC来开发合约。

## 四、参与

投资人与技术人员

在区块链世界即将爆发的前夕，我们如何参与进来

技术人员如何参与-hack substrate

开发合约的过程可以带着三个问题去学习(授人以渔)

1、**交易怎么调用进来；**给一个人转账，怎么对这笔交易进行签名、组装，格式是什么，怎么发送到链上，链上怎么签名解签，如何打包，调用到虚拟机里面去的；之后在虚拟机相关业务逻辑如何处理；

2、**相关业务逻辑如何处理；**用户合约在这一层写；

3、**处理结果如何存储在链上；**逻辑完成后，如何存储，处理结果如何存储到链上，跟什么数据结合，虚拟机里面怎么调用到外层数据库了，怎么交互的；

4、**如何保证一致性/安全性(核心、难点、重点、链级别选手)**；交易打包，如何确认，更多的是牵涉到共识问题，aura共识如何保证一致性，grandapa保证确定性，重点是在一致性问题上。





